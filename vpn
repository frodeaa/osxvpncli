#!/usr/bin/env bash

function help() {
cat <<EOF
Description:
  Establish or terminate VPN connections from an OSX command line

Usage:
  $(basename $0) [OPTION] [vpn_name]

Options:
  connect     <vpn_name>  Establish a new connection
  disconnect  [vpn_name]  Terminate established connections
  status      [vpn_name]  Show connection status
EOF
exit 1
}

function connections() {
  scutil --nc list | awk '
    BEGIN         { FS="\"" }
    /^\*/ {
      if ( /PPP:L2TP.$/ ) { print $2 }
      if ( /IPSec.$/ )    { print $2 }
      if ( /PPP:PPTP.$/ ) { print $2 }
    }
  ' | sort
}

function connection_status() {
  scutil --nc status "$1" | head -n1
  return $?
}

[[ -z $@ ]] && help

for arg in "$@"; do
  [[ $arg == "--help" ]] && help
done

f=$1
shift
c=$(echo $@ | sed 's#\ #\\\ #g')

case $f in
  "connect")
    if [[ -z $c ]]; then
      echo "You must provide a VPN to connect"
      exit 1
    fi
    eval "scutil --nc start $c"
  ;;

  "disconnect")
    if [[ -z $c ]]; then
      echo "You must provide a VPN to disconnect"
      exit 1
    fi
    osascript -e "tell application \"System Events\""                \
              -e "  tell current location of network preferences"    \
              -e "    set VPN to service \"$(echo $c | tr -d '\')\"" \
              -e "    if exists VPN then disconnect VPN"             \
              -e "  end tell"                                        \
              -e "end tell"                                          >/dev/null
  ;;

  "status")
    IFS=$'\n'
    for c in $(connections); do
      output+="${c}:$(connection_status ${c})\n"
    done
    echo -e "${output}" | column -s: -c1 -t
  ;;
esac
